<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Australia Electricity Generation by State (Choropleth + Ranked Bars)</title>
  <!-- Vega & Vega-Lite (from CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <style>
    /* Override Vega tooltip alignment */
    .vega-tooltip { text-align: left !important; }
    .vega-tooltip td { text-align: left !important; }

    :root {
      --bg: #0f172a;
      --card: #111827ee;
      --text: #e5e7eb;
      --accent: #60a5fa;
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: radial-gradient(1200px 800px at 50% -10%, #1f2937, var(--bg));
      display: grid;
      place-items: center;
    }

    .page {
      display: grid;
      grid-template-rows: auto auto auto 1fr;
      gap: 1.25rem;
      width: min(1100px, 92vw);
      padding: 2rem;
      box-sizing: border-box;
    }

    .card {
      background: var(--card);
      border: 1px solid #1f2937;
      border-radius: 1.25rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
      padding: 1.25rem;
    }

    h1 { margin: 0; font-size: clamp(1.6rem, 1rem + 3vw, 2.6rem); line-height: 1.15; }
    p.lead { margin: .25rem 0 0; color: #cbd5e1; max-width: 80ch; }
    .grid-center { display: grid; place-items: center; }

    #map-card { padding: .5rem; }
    #vis { width: min(100%, 900px); height: 650px; cursor: crosshair; }

    .controls { display: flex; gap: .75rem; flex-wrap: wrap; align-items: center; }
    .control { display: grid; gap: .35rem; font-size: .9rem; }

    select {
      background: #0b1220;
      color: var(--text);
      border: 1px solid #1f2937;
      border-radius: .65rem;
      padding: .55rem .7rem;
    }

    /* New viz container width */
    #bars { width: min(100%, 900px); }
    .subhead { margin: 0 0 .5rem; color: #cbd5e1; }
  </style>
</head>

<body>
  <main class="page">
    <!-- ===== HEADER ===== -->
    <header class="card">
      <h1>Australia Electricity Generation by State, <span id="year-label">2023</span></h1>
      <p class="lead">Interactive choropleth using a conic equal-area projection and graticule. Hover for details.</p>
      <small>
        Sources:
        <a href="https://example.com/states.geojson" target="_blank" rel="noopener">states.geojson</a>,
        <a href="https://www.energy.gov.au/energy-data/australian-energy-statistics" target="_blank" rel="noopener">
          Australian Energy Statistics
        </a>
      </small>
    </header>

    <!-- ===== CONTROLS (Map) ===== -->
    <section class="card controls">
      <div class="control">
        <label for="metric">Metric</label>
        <select id="metric">
          <option selected>Per cent renewable generation</option>
          <option>Total</option>
          <option>Total renewable</option>
          <option>Total non-renewable</option>
          <option>Black coal</option>
          <option>Brown coal</option>
          <option>Natural gas</option>
          <option>Oil products</option>
          <option>Biomass</option>
          <option>Wind</option>
          <option>Hydro</option>
          <option>Large-scale solar PV</option>
          <option>Small-scale solar PV</option>
        </select>
      </div>
    </section>

    <!-- ===== MAP ===== -->
    <section id="map-card" class="card grid-center">
      <div id="vis" aria-label="Choropleth map"></div>
    </section>

    <!-- ===== NEW VIZ: RANKED BARS (values_clean.csv only) ===== -->
    <section class="card">
      <h2 class="subhead">Ranked by selected metric â€” with national mean annotation</h2>
      <div class="controls" style="margin-bottom:.5rem">
        <div class="control">
          <label for="bars-metric">Metric</label>
          <select id="bars-metric">
            <option>Total</option>
            <option>Total renewable</option>
            <option>Total non-renewable</option>
            <option>Per cent renewable generation</option>
            <option>Black coal</option>
            <option>Brown coal</option>
            <option>Natural gas</option>
            <option>Oil products</option>
            <option>Biomass</option>
            <option>Wind</option>
            <option>Hydro</option>
            <option>Large-scale solar PV</option>
            <option>Small-scale solar PV</option>
          </select>
        </div>
      </div>
      <div id="bars" aria-label="Ranked bar chart"></div>
      <small>Tip: The dotted line shows the national mean for the chosen metric; hover bars for details.</small>
    </section>

    <footer class="card">
      <small>
        Sources:
        <a href="https://example.com/states.geojson" target="_blank" rel="noopener">states.geojson</a>,
        <a href="https://www.energy.gov.au/energy-data/australian-energy-statistics" target="_blank" rel="noopener">
          Australian Energy Statistics
        </a>
      </small>
    </footer>
  </main>

  <script>
    // ---- Paths to your data files ----
    const GEOJSON_URL = './states.geojson';
    const CSV_URL = './values_clean.csv';
    const DATA_YEAR = '2023';
    const scheme = 'oranges'; // locked

    const metricSelect = document.getElementById('metric');
    const barsMetricSelect = document.getElementById('bars-metric');
    const yearLabel = document.getElementById('year-label');
    yearLabel.textContent = DATA_YEAR;

    function unitsFor(metric) {
      // Assume % if name contains 'Per cent' or '%', else GWh
      return /%|Per cent/i.test(metric) ? '' : ' (GWh)';
    }

    /* ===============================
     * MAP (your original buildSpec)
     * =============================== */
    function buildSpec(selectedMetric) {
      const legendTitle = selectedMetric + unitsFor(selectedMetric);

      return {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        width: 'container',
        height: 610,
        background: null,
        config: {
          view: { stroke: null },
          axis: { grid: false, labelColor: '#e5e7eb', titleColor: '#e5e7eb' },
          legend: { labelColor: '#e5e7eb', titleColor: '#e5e7eb' }
        },
        projection: {
          type: 'conicEqualArea',
          center: [135, -27],
          rotate: [-140, 0, 0],
          parallels: [-18, -36],
          scale: 540,
          translate: [1300, 820]
        },
        layer: [
          // 1) Graticule
          {
            data: { graticule: true },
            mark: { type: 'geoshape', stroke: '#64748b', strokeWidth: 0.5, fill: null, opacity: 0.35 }
          },
          // 2) Choropleth
          {
            data: { url: GEOJSON_URL, format: { type: 'json', property: 'features' } },
            transform: [
              { calculate: 'datum.properties.STATE_NAME || datum.properties.state || datum.properties.State || datum.properties.name', as: 'state_key' },
              {
                lookup: 'state_key',
                from: {
                  data: { url: CSV_URL },
                  key: 'state',
                  fields: [
                    'Total', 'Total renewable', 'Total non-renewable', 'Per cent renewable generation',
                    'Black coal', 'Brown coal', 'Natural gas', 'Oil products', 'Biomass', 'Wind', 'Hydro',
                    'Large-scale solar PV', 'Small-scale solar PV',
                    // Optional if present:
                    'population', 'area_km2'
                  ]
                }
              },
              { calculate: `toNumber(datum[${JSON.stringify(selectedMetric)}])`, as: 'metric_value' },
              { calculate: `isFinite(datum.metric_value) ? datum.metric_value : null`, as: 'metric_label' },
              { joinaggregate: [{ op: 'sum', field: 'metric_value', as: 'total_metric' }] },
              { calculate: 'isFinite(datum.metric_value) && isFinite(datum.total_metric) && datum.total_metric>0 ? (datum.metric_value/datum.total_metric)*100 : null', as: 'share_pct' },
              { calculate: 'isFinite(datum.metric_value) && isFinite(datum.population) && datum.population>0 ? (datum.metric_value/datum.population)*100000 : null', as: 'per_100k' },
              { calculate: 'isValid(datum.metric_value)', as: 'hasData' }
            ],
            mark: { type: 'geoshape', stroke: '#0b1220', strokeWidth: 1 },
            encoding: {
              color: {
                field: 'metric_value', type: 'quantitative',
                scale: { scheme: scheme, nice: true },
                legend: { title: legendTitle }
              },
              opacity: { condition: { test: 'datum.hasData', value: 1 }, value: 0.35 },
              tooltip: [
                { field: 'state_key', title: 'State' },
                { field: 'share_pct', title: 'Share of AU (%)', type: 'quantitative', format: ',.2f' },
                { field: 'metric_label', title: legendTitle, type: 'quantitative', format: ',.2f' }
              ]
            }
          }
        ]
      };
    }

    async function renderMap() {
      const spec = buildSpec(metricSelect.value);
      await vegaEmbed('#vis', spec, { renderer: 'canvas', actions: false });
    }

    metricSelect.addEventListener('change', renderMap);
    renderMap(); // initial render

    /* ===============================
     * NEW VIZ: Ranked Bars (values_clean.csv only)
     * =============================== */
    function barsSpec(selectedMetric) {
      const legendTitle = selectedMetric + (/%|Per cent/i.test(selectedMetric) ? "" : " (GWh)");
      const metricsList = [
        'Total','Total renewable','Total non-renewable','Per cent renewable generation',
        'Black coal','Brown coal','Natural gas','Oil products','Biomass','Wind','Hydro',
        'Large-scale solar PV','Small-scale solar PV'
      ];

      return {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        width: 'container',
        height: 520,
        background: null,
        data: { url: CSV_URL },
        config: {
          view: { stroke: null },
          axis: { grid: true, gridColor: '#1f2937', labelColor: '#e5e7eb', titleColor: '#e5e7eb' },
          legend: { labelColor: '#e5e7eb', titleColor: '#e5e7eb' }
        },
        transform: [
          { fold: metricsList, as: ['metric','value'] },
          { filter: `datum.metric == ${JSON.stringify(selectedMetric)}` },
          { calculate: "toNumber(datum.value)", as: "val" },
          { calculate: "isFinite(datum.val) ? datum.val : null", as: "val_clean" }
        ],
        layer: [
          /* Bars */
          {
            mark: { type: 'bar', cornerRadiusEnd: 4 },
            encoding: {
              y: {
                field: 'state', type: 'nominal',
                sort: '-x', title: 'State/Territory',
                axis: { labelLimit: 180 }
              },
              x: {
                field: 'val_clean', type: 'quantitative',
                title: legendTitle, axis: { format: ',.2f' }
              },
              tooltip: [
                { field: 'state', title: 'State' },
                { field: 'metric', title: 'Metric' },
                { field: 'val_clean', title: 'Value', type: 'quantitative', format: ',.2f' }
              ]
            }
          },
          /* Mean rule annotation */
          {
            transform: [{ aggregate: [{ op: 'mean', field: 'val_clean', as: 'mean_val' }] }],
            mark: { type: 'rule', strokeDash: [6,4] },
            encoding: { x: { field: 'mean_val', type: 'quantitative' } }
          },
          /* Mean text label */
          {
            transform: [{ aggregate: [{ op: 'mean', field: 'val_clean', as: 'mean_val' }] }],
            mark: { type: 'text', dx: 6, dy: -8, fontWeight: 'bold', fill: '#cbd5e1' },
            encoding: {
              x: { field: 'mean_val', type: 'quantitative' },
              y: { value: 0 },
              text: { value: 'National mean' }
            }
          }
        ]
      };
    }

    async function renderBars() {
      const spec = barsSpec(barsMetricSelect.value);
      await vegaEmbed('#bars', spec, { renderer: 'canvas', actions: false });
    }

    barsMetricSelect.addEventListener('change', renderBars);
    renderBars(); // initial render
  </script>
</body>
</html>
